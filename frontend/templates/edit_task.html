{% extends 'base.html' %}
{% block title %}Edit Task - Task Tracker{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4">Edit Task</h2>

    <form id="edit_task_form" action="/tasks/{{ task.id }}/edit" method="post" class="card p-4 shadow-sm mx-auto" style="max-width: 500px;">
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" id="title" name="title" class="form-control" value="{{ task.title }}" required>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea id="description" name="description" rows="3" class="form-control">{{ task.description }}</textarea>
        </div>

        <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select id="status" name="status_" class="form-select">
                <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>To Do</option>
                <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
            </select>
        </div>

        <div class="mb-3" id="start_time_container">
            <label for="start_time" class="form-label">Start Time</label>
            <input type="datetime-local" id="start_time" name="start_time" class="form-control"
                value="{{ task.start_time.strftime('%Y-%m-%dT%H:%M') if task.start_time else '' }}">
        </div>

        <div class="mb-3" id="end_time_container">
            <label for="end_time" class="form-label">End Time</label>
            <input type="datetime-local" id="end_time" name="end_time" class="form-control"
                value="{{ task.end_time.strftime('%Y-%m-%dT%H:%M') if task.end_time else '' }}">
        </div>

        <div class="text-center mb-2">
            <button type="submit" class="btn btn-success">Update Task</button>
            <a href="/tasks/{{ task.id }}" class="btn btn-secondary ms-2">Cancel</a>
        </div>

        <div class="text-center">
            {% if task.status != 'done' %}
            <button type="button" id="mark_done_btn" class="btn btn-primary">Mark Done</button>
            {% endif %}
        </div>
    </form>
</div>

<script>
const statusSelect = document.getElementById('status');
const startContainer = document.getElementById('start_time_container');
const endContainer = document.getElementById('end_time_container');
const startTimeInput = document.getElementById('start_time');
const endTimeInput = document.getElementById('end_time');
const markDoneBtn = document.getElementById('mark_done_btn');

function toggleTimeFields() {
    const status = statusSelect.value;
    const now = new Date();
    const formattedNow = now.toISOString().slice(0,16);

    if (status === 'todo') {
        startContainer.style.display = 'none';
        endContainer.style.display = 'none';
        startTimeInput.value = '';
        endTimeInput.value = '';
    } else if (status === 'in_progress') {
        startContainer.style.display = 'block';
        endContainer.style.display = 'none';
        if (!startTimeInput.value) startTimeInput.value = formattedNow;
        endTimeInput.value = '';
    } else if (status === 'done') {
        startContainer.style.display = 'block';
        endContainer.style.display = 'block';
        if (!startTimeInput.value) startTimeInput.value = formattedNow;
        endTimeInput.value = formattedNow;
    }
}

toggleTimeFields();

statusSelect.addEventListener('change', toggleTimeFields);

if (markDoneBtn) {
    markDoneBtn.addEventListener('click', () => {
        statusSelect.value = 'done';
        toggleTimeFields();
    });
}
</script>
{% endblock %}